# CI Pipeline
# Order: risk-policy-gate (preflight, separate workflow) → lint → test → harness-smoke → build
# risk-policy-gate is enforced as a required check via branch protection.

name: CI Pipeline

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - run: pip install ruff
      - run: ruff check src/ tests/

  test:
    name: CI Pipeline
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    services:
      postgres:
        image: pgvector/pgvector:0.8.1-pg17
        env:
          POSTGRES_USER: pkg
          POSTGRES_PASSWORD: pkg
          POSTGRES_DB: pkg_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    env:
      POSTGRES_URL: postgresql://pkg:pkg@localhost:5432/pkg_test
      OLLAMA_BASE_URL: http://localhost:11434
      FALKORDB_HOST: localhost
      FALKORDB_PORT: 6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - name: Install dependencies
        run: pip install -e ".[test]"
      - name: Apply schema
        run: psql "$POSTGRES_URL" -f db/init.sql
      - name: Run tests
        run: pytest tests/ --tb=short -q --ignore=tests/harness

  harness-smoke:
    name: harness-smoke
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    services:
      postgres:
        image: pgvector/pgvector:0.8.1-pg17
        env:
          POSTGRES_USER: pkg
          POSTGRES_PASSWORD: pkg
          POSTGRES_DB: pkg_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    env:
      POSTGRES_URL: postgresql://pkg:pkg@localhost:5432/pkg_test
      OLLAMA_BASE_URL: http://localhost:11434
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - run: pip install -e ".[test]"
      - run: psql "$POSTGRES_URL" -f db/init.sql
      - run: pytest tests/harness/ --tb=short -q

  build:
    name: Build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Validate docker-compose
        run: docker compose config --quiet
      - name: Build images
        run: docker compose build --no-cache
